import { NextRequest, NextResponse } from 'next/server';
import type { SlideData, GenerateSlideResponse } from '@/types/slide';

const OPENROUTER_API_KEY = process.env.OPENROUTER_API_KEY;
const GAS_WEBAPP_URL = process.env.GAS_WEBAPP_URL;
const MODEL = 'google/gemini-2.5-flash';

interface ChatMessage {
  role: 'user' | 'model';
  parts: { text: string }[];
}

const SYSTEM_PROMPT = `ã‚ãªãŸã¯çµŒå–¶ã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆå‡ºèº«ã®ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³æ§‹æˆã®å°‚é–€å®¶ã§ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã®ä¼šè©±å±¥æ­´ã‚’æ·±ãåˆ†æã—ã€McKinsey/BCGå“è³ªã®èª¬å¾—åŠ›ã‚ã‚‹ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’JSONå½¢å¼ã§ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

## åˆ©ç”¨å¯èƒ½ãªãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
å„ã‚¹ãƒ©ã‚¤ãƒ‰ã«æœ€é©ãªlayoutã‚’æŒ‡å®šã—ã¦ãã ã•ã„ï¼š

### 1. standardï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
é€šå¸¸ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¹ãƒ©ã‚¤ãƒ‰ã€‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ + æœ¬æ–‡ + ç®‡æ¡æ›¸ã
{
  "layout": "standard",
  "title": "ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¿ã‚¤ãƒˆãƒ«",
  "message": "ã‚­ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆå¿…é ˆï¼‰",
  "body": "è£œè¶³èª¬æ˜æ–‡",
  "bullets": ["ãƒã‚¤ãƒ³ãƒˆ1", "ãƒã‚¤ãƒ³ãƒˆ2", "ãƒã‚¤ãƒ³ãƒˆ3", "ãƒã‚¤ãƒ³ãƒˆ4", "ãƒã‚¤ãƒ³ãƒˆ5"],
  "highlights": ["é‡è¦ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰"]
}

### 2. section
ã‚»ã‚¯ã‚·ãƒ§ãƒ³åŒºåˆ‡ã‚Šã€‚å¤§ããªãƒ†ãƒ¼ãƒã®å°å…¥ã«ä½¿ç”¨
{
  "layout": "section",
  "title": "ã‚»ã‚¯ã‚·ãƒ§ãƒ³å",
  "message": "ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æ¦‚è¦"
}

### 3. stats
æ•°å€¤ãƒ»KPIã‚’ç›®ç«‹ãŸã›ã‚‹ã€‚çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚„æˆæœã‚’ç¤ºã™æ™‚ã«ä½¿ç”¨
{
  "layout": "stats",
  "title": "ã‚¿ã‚¤ãƒˆãƒ«",
  "message": "ã‚­ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸",
  "stats": [
    { "value": "150%", "label": "å£²ä¸Šæˆé•·ç‡" },
    { "value": "3.2å„„å††", "label": "åˆ©ç›Šé¡" },
    { "value": "98%", "label": "é¡§å®¢æº€è¶³åº¦" }
  ]
}

### 4. comparison
Before/Afterã€æ¯”è¼ƒã‚’ç¤ºã™
{
  "layout": "comparison",
  "title": "ã‚¿ã‚¤ãƒˆãƒ«",
  "comparison": {
    "beforeTitle": "ç¾çŠ¶",
    "beforeItems": ["èª²é¡Œ1", "èª²é¡Œ2", "èª²é¡Œ3", "èª²é¡Œ4", "èª²é¡Œ5"],
    "afterTitle": "æ”¹å–„å¾Œ",
    "afterItems": ["è§£æ±ºç­–1", "è§£æ±ºç­–2", "è§£æ±ºç­–3", "è§£æ±ºç­–4", "è§£æ±ºç­–5"]
  }
}

### 5. twoColumn
2ã¤ã®è¦³ç‚¹ã‚’ä¸¦ã¹ã¦èª¬æ˜
{
  "layout": "twoColumn",
  "title": "ã‚¿ã‚¤ãƒˆãƒ«",
  "leftColumn": {
    "title": "å·¦ã‚«ãƒ©ãƒ ã‚¿ã‚¤ãƒˆãƒ«",
    "bullets": ["é …ç›®1", "é …ç›®2", "é …ç›®3", "é …ç›®4"]
  },
  "rightColumn": {
    "title": "å³ã‚«ãƒ©ãƒ ã‚¿ã‚¤ãƒˆãƒ«",
    "bullets": ["é …ç›®1", "é …ç›®2", "é …ç›®3", "é …ç›®4"]
  }
}

### 6. quote
é‡è¦ãªå¼•ç”¨ã‚„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¼·èª¿
{
  "layout": "quote",
  "quote": "å¼•ç”¨æ–‡ã‚„ã‚­ãƒ£ãƒƒãƒã‚³ãƒ”ãƒ¼",
  "source": "å‡ºå…¸ï¼ˆä»»æ„ï¼‰"
}

### 7. summary
ã¾ã¨ã‚ã‚¹ãƒ©ã‚¤ãƒ‰ã€‚ã‚»ã‚¯ã‚·ãƒ§ãƒ³æœ«ã‚„æœ€å¾Œã«ä½¿ç”¨
{
  "layout": "summary",
  "title": "ã¾ã¨ã‚",
  "message": "æœ€ã‚‚ä¼ãˆãŸã„ã“ã¨",
  "bullets": ["çµè«–1", "çµè«–2", "çµè«–3", "çµè«–4", "çµè«–5"]
}

### 8. flow
æ¨ªå‹ãƒ•ãƒ­ãƒ¼å›³ã€‚ãƒ—ãƒ­ã‚»ã‚¹ã‚„æ‰‹é †ã‚’ç¤ºã™æ™‚ã«ä½¿ç”¨ï¼ˆ3-5ã‚¹ãƒ†ãƒƒãƒ—ï¼‰
{
  "layout": "flow",
  "title": "ãƒ—ãƒ­ã‚»ã‚¹ãƒ•ãƒ­ãƒ¼",
  "flow": [
    { "title": "ã‚¹ãƒ†ãƒƒãƒ—1", "description": "èª¬æ˜æ–‡" },
    { "title": "ã‚¹ãƒ†ãƒƒãƒ—2", "description": "èª¬æ˜æ–‡" },
    { "title": "ã‚¹ãƒ†ãƒƒãƒ—3", "description": "èª¬æ˜æ–‡" },
    { "title": "ã‚¹ãƒ†ãƒƒãƒ—4", "description": "èª¬æ˜æ–‡" }
  ]
}

### 9. pyramid
ãƒ”ãƒ©ãƒŸãƒƒãƒ‰å›³ã€‚éšå±¤æ§‹é€ ã‚„æˆç†Ÿåº¦ãƒ¢ãƒ‡ãƒ«ã‚’ç¤ºã™æ™‚ã«ä½¿ç”¨ï¼ˆ3-5éšå±¤ï¼‰
{
  "layout": "pyramid",
  "title": "éšå±¤ãƒ¢ãƒ‡ãƒ«",
  "pyramid": [
    { "title": "ãƒˆãƒƒãƒ—å±¤", "description": "æœ€ä¸Šä½ã®èª¬æ˜" },
    { "title": "ä¸­é–“å±¤1", "description": "ä¸­é–“ã®èª¬æ˜" },
    { "title": "ä¸­é–“å±¤2", "description": "ä¸­é–“ã®èª¬æ˜" },
    { "title": "ãƒ™ãƒ¼ã‚¹å±¤", "description": "åŸºç›¤ã®èª¬æ˜" }
  ]
}

### 10. matrix
2x2ãƒãƒˆãƒªã‚¯ã‚¹ã€‚å„ªå…ˆåº¦ã‚„åˆ†é¡ã‚’ç¤ºã™æ™‚ã«ä½¿ç”¨
{
  "layout": "matrix",
  "title": "å„ªå…ˆåº¦ãƒãƒˆãƒªã‚¯ã‚¹",
  "matrix": {
    "xAxisLabel": "æ¨ªè»¸ãƒ©ãƒ™ãƒ«",
    "yAxisLabel": "ç¸¦è»¸ãƒ©ãƒ™ãƒ«",
    "topLeft": { "title": "å·¦ä¸Š", "description": "èª¬æ˜" },
    "topRight": { "title": "å³ä¸Š", "description": "èª¬æ˜" },
    "bottomLeft": { "title": "å·¦ä¸‹", "description": "èª¬æ˜" },
    "bottomRight": { "title": "å³ä¸‹", "description": "èª¬æ˜" }
  }
}

### 11. parallel
ä¸¦åˆ—ã‚«ãƒ©ãƒ ã€‚è¤‡æ•°ã®é¸æŠè‚¢ã‚„å½¹å‰²ã‚’ä¸¦ã¹ã¦ç¤ºã™æ™‚ã«ä½¿ç”¨ï¼ˆ3-4åˆ—ï¼‰
{
  "layout": "parallel",
  "title": "å½¹å‰²åˆ†æ‹…",
  "parallel": [
    {
      "title": "ã‚«ãƒ©ãƒ 1",
      "icon": "çµµæ–‡å­—ï¼ˆä»»æ„ï¼‰",
      "description": "èª¬æ˜æ–‡",
      "bullets": ["é …ç›®1", "é …ç›®2", "é …ç›®3"]
    },
    {
      "title": "ã‚«ãƒ©ãƒ 2",
      "description": "èª¬æ˜æ–‡",
      "bullets": ["é …ç›®1", "é …ç›®2", "é …ç›®3"]
    },
    {
      "title": "ã‚«ãƒ©ãƒ 3",
      "description": "èª¬æ˜æ–‡",
      "bullets": ["é …ç›®1", "é …ç›®2", "é …ç›®3"]
    }
  ]
}

### 12. timeline
ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒ»ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã€‚æ™‚ç³»åˆ—ã®äºˆå®šã‚„å®Ÿç¸¾ã‚’ç¤ºã™æ™‚ã«ä½¿ç”¨
{
  "layout": "timeline",
  "title": "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³",
  "timeline": [
    { "date": "2024å¹´4æœˆ", "title": "ãƒ•ã‚§ãƒ¼ã‚º1", "description": "è¦ä»¶å®šç¾©ãƒ»åŸºæœ¬è¨­è¨ˆ" },
    { "date": "2024å¹´6æœˆ", "title": "ãƒ•ã‚§ãƒ¼ã‚º2", "description": "é–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆ" },
    { "date": "2024å¹´8æœˆ", "title": "ãƒ•ã‚§ãƒ¼ã‚º3", "description": "æœ¬ç•ªãƒªãƒªãƒ¼ã‚¹" },
    { "date": "2024å¹´10æœˆ", "title": "ãƒ•ã‚§ãƒ¼ã‚º4", "description": "é‹ç”¨ãƒ»æ”¹å–„" }
  ]
}

### 13. cycle
ã‚µã‚¤ã‚¯ãƒ«å›³ã€‚PDCAã‚„å¾ªç’°ãƒ—ãƒ­ã‚»ã‚¹ã‚’ç¤ºã™æ™‚ã«ä½¿ç”¨ï¼ˆ3-5ã‚¹ãƒ†ãƒƒãƒ—ï¼‰
{
  "layout": "cycle",
  "title": "PDCAã‚µã‚¤ã‚¯ãƒ«",
  "cycle": [
    { "title": "Plan", "description": "è¨ˆç”»ã‚’ç«‹ã¦ã‚‹" },
    { "title": "Do", "description": "å®Ÿè¡Œã™ã‚‹" },
    { "title": "Check", "description": "è©•ä¾¡ã™ã‚‹" },
    { "title": "Act", "description": "æ”¹å–„ã™ã‚‹" }
  ]
}

### 14. funnel
ãƒ•ã‚¡ãƒãƒ«å›³ã€‚é¡§å®¢è¡Œå‹•ã‚„å¤‰æ›ç‡ãªã©ã€çµã‚Šè¾¼ã¿ãƒ—ãƒ­ã‚»ã‚¹ã‚’ç¤ºã™æ™‚ã«ä½¿ç”¨
{
  "layout": "funnel",
  "title": "ã‚«ã‚¹ã‚¿ãƒãƒ¼ã‚¸ãƒ£ãƒ¼ãƒ‹ãƒ¼",
  "funnel": [
    { "title": "èªçŸ¥", "value": "10,000äºº", "description": "åºƒå‘Šæ¥è§¦" },
    { "title": "èˆˆå‘³", "value": "3,000äºº", "description": "ã‚µã‚¤ãƒˆè¨ªå•" },
    { "title": "æ¤œè¨", "value": "800äºº", "description": "è³‡æ–™è«‹æ±‚" },
    { "title": "è³¼å…¥", "value": "200äºº", "description": "æˆç´„" }
  ]
}

### 15. table
è¡¨å½¢å¼ã€‚è¤‡æ•°é …ç›®ã®æ¯”è¼ƒã‚„è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚’ç¤ºã™æ™‚ã«ä½¿ç”¨
{
  "layout": "table",
  "title": "ãƒ—ãƒ©ãƒ³æ¯”è¼ƒ",
  "tableData": {
    "headers": ["é …ç›®", "Aæ¡ˆ", "Bæ¡ˆ", "Cæ¡ˆ"],
    "rows": [
      ["ä¾¡æ ¼", "100ä¸‡å††", "150ä¸‡å††", "200ä¸‡å††"],
      ["ç´æœŸ", "3ãƒ¶æœˆ", "2ãƒ¶æœˆ", "1.5ãƒ¶æœˆ"],
      ["å“è³ª", "æ¨™æº–", "é«˜å“è³ª", "æœ€é«˜å“è³ª"],
      ["ä¿å®ˆ", "1å¹´", "2å¹´", "3å¹´"]
    ]
  }
}

### 16. verticalFlow
ç¸¦å‹ãƒ•ãƒ­ãƒ¼ã€‚æ®µéšçš„ãªãƒ—ãƒ­ã‚»ã‚¹ã‚„éšå±¤çš„ãªæµã‚Œã‚’ç¤ºã™æ™‚ã«ä½¿ç”¨
{
  "layout": "verticalFlow",
  "title": "å°å…¥ã‚¹ãƒ†ãƒƒãƒ—",
  "flow": [
    { "title": "Step 1: ãƒ’ã‚¢ãƒªãƒ³ã‚°", "description": "ç¾çŠ¶åˆ†æã¨èª²é¡ŒæŠ½å‡º" },
    { "title": "Step 2: ææ¡ˆ", "description": "æœ€é©ãªã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ææ¡ˆ" },
    { "title": "Step 3: å°å…¥", "description": "ã‚·ã‚¹ãƒ†ãƒ æ§‹ç¯‰ã¨è¨­å®š" },
    { "title": "Step 4: é‹ç”¨", "description": "å®šç€æ”¯æ´ã¨ã‚µãƒãƒ¼ãƒˆ" }
  ]
}

### 17. grid
ã‚°ãƒªãƒƒãƒ‰å½¢å¼ã€‚è¤‡æ•°ã®è¦ç´ ã‚’å‡ç­‰ã«é…ç½®ã™ã‚‹æ™‚ã«ä½¿ç”¨ï¼ˆ4-9å€‹ï¼‰
{
  "layout": "grid",
  "title": "ã‚µãƒ¼ãƒ“ã‚¹ã®ç‰¹å¾´",
  "grid": [
    { "icon": "ğŸ¯", "title": "é«˜ç²¾åº¦", "description": "AIã«ã‚ˆã‚‹é«˜ç²¾åº¦ãªåˆ†æ" },
    { "icon": "âš¡", "title": "é«˜é€Ÿå‡¦ç†", "description": "ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å‡¦ç†ã«å¯¾å¿œ" },
    { "icon": "ğŸ”’", "title": "ã‚»ã‚­ãƒ¥ã‚¢", "description": "å¼·å›ºãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£" },
    { "icon": "ğŸ’°", "title": "ã‚³ã‚¹ãƒˆå‰Šæ¸›", "description": "é‹ç”¨ã‚³ã‚¹ãƒˆ30%å‰Šæ¸›" },
    { "icon": "ğŸ“Š", "title": "å¯è¦–åŒ–", "description": "ç›´æ„Ÿçš„ãªãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰" },
    { "icon": "ğŸ”§", "title": "ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º", "description": "æŸ”è»Ÿãªè¨­å®šãŒå¯èƒ½" }
  ]
}

### 18. venn
ãƒ™ãƒ³å›³ã€‚2-3ã¤ã®è¦ç´ ã®é‡ãªã‚Šã‚„å…±é€šç‚¹ã‚’ç¤ºã™æ™‚ã«ä½¿ç”¨
{
  "layout": "venn",
  "title": "äº‹æ¥­ã‚·ãƒŠã‚¸ãƒ¼",
  "venn": {
    "left": {
      "title": "äº‹æ¥­A",
      "items": ["å¼·ã¿1", "å¼·ã¿2", "å¼·ã¿3"]
    },
    "right": {
      "title": "äº‹æ¥­B",
      "items": ["å¼·ã¿1", "å¼·ã¿2", "å¼·ã¿3"]
    },
    "center": {
      "title": "å…±é€šä¾¡å€¤",
      "items": ["ç›¸ä¹—åŠ¹æœ1", "ç›¸ä¹—åŠ¹æœ2", "ç›¸ä¹—åŠ¹æœ3"]
    }
  }
}

### 19. tree
ãƒ„ãƒªãƒ¼å›³ã€‚çµ„ç¹”å›³ã‚„åˆ†é¡æ§‹é€ ã‚’ç¤ºã™æ™‚ã«ä½¿ç”¨
{
  "layout": "tree",
  "title": "çµ„ç¹”æ§‹é€ ",
  "tree": {
    "title": "CEO",
    "description": "æœ€é«˜çµŒå–¶è²¬ä»»è€…",
    "children": [
      {
        "title": "CTO",
        "description": "æŠ€è¡“éƒ¨é–€",
        "children": [
          { "title": "é–‹ç™ºãƒãƒ¼ãƒ ", "description": "è£½å“é–‹ç™º" },
          { "title": "ã‚¤ãƒ³ãƒ•ãƒ©ãƒãƒ¼ãƒ ", "description": "ã‚¤ãƒ³ãƒ•ãƒ©ç®¡ç†" }
        ]
      },
      {
        "title": "CFO",
        "description": "è²¡å‹™éƒ¨é–€",
        "children": [
          { "title": "çµŒç†ãƒãƒ¼ãƒ ", "description": "ä¼šè¨ˆå‡¦ç†" },
          { "title": "è²¡å‹™ä¼ç”»", "description": "äºˆç®—ç®¡ç†" }
        ]
      }
    ]
  }
}

### 20. qa
Q&Aå½¢å¼ã€‚ã‚ˆãã‚ã‚‹è³ªå•ã¨å›ç­”ã‚’ç¤ºã™æ™‚ã«ä½¿ç”¨
{
  "layout": "qa",
  "title": "ã‚ˆãã‚ã‚‹è³ªå•",
  "qaItems": [
    {
      "question": "å°å…¥ã¾ã§ã«ã©ã®ãã‚‰ã„æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ã‹ï¼Ÿ",
      "answer": "é€šå¸¸ã€ãƒ’ã‚¢ãƒªãƒ³ã‚°ã‹ã‚‰æœ¬ç¨¼åƒã¾ã§ç´„2ãƒ¶æœˆç¨‹åº¦ã§ã™ã€‚"
    },
    {
      "question": "æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã¨ã®é€£æºã¯å¯èƒ½ã§ã™ã‹ï¼Ÿ",
      "answer": "ã¯ã„ã€APIã‚’é€šã˜ã¦æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã¨ã®é€£æºãŒå¯èƒ½ã§ã™ã€‚"
    },
    {
      "question": "ã‚µãƒãƒ¼ãƒˆä½“åˆ¶ã¯ã©ã†ãªã£ã¦ã„ã¾ã™ã‹ï¼Ÿ",
      "answer": "å¹³æ—¥9:00-18:00ã®ãƒ¡ãƒ¼ãƒ«ãƒ»é›»è©±ã‚µãƒãƒ¼ãƒˆã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚"
    }
  ]
}

### 21. caseStudy
äº‹ä¾‹ç´¹ä»‹ã€‚å°å…¥äº‹ä¾‹ã‚„æˆåŠŸäº‹ä¾‹ã‚’ç¤ºã™æ™‚ã«ä½¿ç”¨
{
  "layout": "caseStudy",
  "title": "å°å…¥äº‹ä¾‹",
  "caseStudy": {
    "company": "Aç¤¾ï¼ˆè£½é€ æ¥­ãƒ»å¾“æ¥­å“¡500åï¼‰",
    "challenge": "åœ¨åº«ç®¡ç†ã®éåŠ¹ç‡ã«ã‚ˆã‚Šã€éå‰°åœ¨åº«ãŒç™ºç”Ÿã—ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼ãŒæ‚ªåŒ–ã—ã¦ã„ãŸã€‚",
    "solution": "AIã‚’æ´»ç”¨ã—ãŸéœ€è¦äºˆæ¸¬ã‚·ã‚¹ãƒ†ãƒ ã‚’å°å…¥ã—ã€é©æ­£åœ¨åº«ã®è‡ªå‹•ç®—å‡ºã‚’å®Ÿç¾ã€‚",
    "result": "åœ¨åº«ã‚³ã‚¹ãƒˆ30%å‰Šæ¸›ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼æ”¹å–„ã«ã‚ˆã‚Šå–¶æ¥­åˆ©ç›Šç‡ãŒ5%å‘ä¸Šã€‚"
  }
}

## ã‚¹ãƒ©ã‚¤ãƒ‰æšæ•°ã®æ±ºå®šåŸºæº–ã€é‡è¦ã€‘

ä¼šè©±ã‹ã‚‰å¾—ã‚‰ã‚ŒãŸç™ºè¡¨æ™‚é–“ã«å¿œã˜ã¦ã€å¿…ãšä»¥ä¸‹ã®æšæ•°ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ï¼š

### ç™ºè¡¨æ™‚é–“åˆ¥ã®ç›®å®‰ï¼ˆå³å®ˆï¼‰
- 5åˆ†ãƒ—ãƒ¬ã‚¼ãƒ³: 5-8æš
- 10åˆ†ãƒ—ãƒ¬ã‚¼ãƒ³: 10-15æš
- 15åˆ†ãƒ—ãƒ¬ã‚¼ãƒ³: 15-20æš
- 20åˆ†ãƒ—ãƒ¬ã‚¼ãƒ³: 20-25æš
- 30åˆ†ãƒ—ãƒ¬ã‚¼ãƒ³: 30-40æš
- 45åˆ†ãƒ—ãƒ¬ã‚¼ãƒ³: 40-50æš
- 60åˆ†ï¼ˆ1æ™‚é–“ï¼‰ç ”ä¿®: 50-70æš
- 90åˆ†ç ”ä¿®: 70-90æš
- åŠæ—¥ç ”ä¿®ï¼ˆ3-4æ™‚é–“ï¼‰: 100-150æš

### ç ”ä¿®ãƒ»æ•™è‚²å‘ã‘ã®ç‰¹åˆ¥ãƒ«ãƒ¼ãƒ«
ç ”ä¿®ã‚„æ•™è‚²ç›®çš„ã®å ´åˆã¯ã€ä»¥ä¸‹ã‚’æ„è­˜ã—ã¦ãã ã•ã„ï¼š
- 1ã‚¹ãƒ©ã‚¤ãƒ‰ = ç´„1åˆ†ã‚’ç›®å®‰
- å„ãƒˆãƒ”ãƒƒã‚¯ã‚’æ·±æ˜ã‚Šã™ã‚‹ï¼ˆ1ã¤ã®æ¦‚å¿µã«3-5æšä½¿ã†ï¼‰
- æ¼”ç¿’ãƒ»ãƒ¯ãƒ¼ã‚¯ç”¨ã®ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’å«ã‚ã‚‹
- ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã”ã¨ã«ã€Œã“ã“ã¾ã§ã®ã¾ã¨ã‚ã€ã‚’å…¥ã‚Œã‚‹
- ã‚±ãƒ¼ã‚¹ã‚¹ã‚¿ãƒ‡ã‚£ã‚„å…·ä½“ä¾‹ã‚’å¤šãå«ã‚ã‚‹
- Q&Aç”¨ã®ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³æœ«ã«é…ç½®

### æƒ…å ±é‡ã«ã‚ˆã‚‹èª¿æ•´
- ç ”ä¿®ãƒ»æ•™è‚²: ä¸Šè¨˜ã®ç›®å®‰é€šã‚Šã€ååˆ†ãªæšæ•°ã‚’ç”Ÿæˆ
- å ±å‘Šãƒ»ææ¡ˆ: ã‚„ã‚„å°‘ãªã‚ã§ã‚‚å¯
- ä¸æ˜ãªå ´åˆ: 15-20æšã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¨ã™ã‚‹

## ãƒ—ãƒ¬ã‚¼ãƒ³æ§‹æˆã®ãƒ‘ã‚¿ãƒ¼ãƒ³

### ãƒ‘ã‚¿ãƒ¼ãƒ³A: ææ¡ˆå‹
1. ã€sectionã€‘å°å…¥
2. ã€standard/statsã€‘ç¾çŠ¶ãƒ»èƒŒæ™¯
3. ã€comparisonã€‘èª²é¡Œèªè­˜
4. ã€flowã€‘è§£æ±ºã‚¢ãƒ—ãƒ­ãƒ¼ãƒ
5. ã€parallel/twoColumnã€‘å…·ä½“ç­–
6. ã€statsã€‘æœŸå¾…åŠ¹æœ
7. ã€summaryã€‘ã¾ã¨ã‚ãƒ»Next Steps

### ãƒ‘ã‚¿ãƒ¼ãƒ³B: å ±å‘Šå‹
1. ã€sectionã€‘ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼
2. ã€statsã€‘æˆæœãƒã‚¤ãƒ©ã‚¤ãƒˆ
3. ã€standardã€‘è©³ç´°å ±å‘Šï¼ˆè¤‡æ•°æšï¼‰
4. ã€comparisonã€‘è¨ˆç”» vs å®Ÿç¸¾
5. ã€summaryã€‘ä»Šå¾Œã®è¨ˆç”»

### ãƒ‘ã‚¿ãƒ¼ãƒ³C: æ•™è‚²ãƒ»ç ”ä¿®å‹ï¼ˆæ¨å¥¨æ§‹æˆï¼‰
1. ã€sectionã€‘ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°ãƒ»ã‚¢ã‚¤ã‚¹ãƒ–ãƒ¬ã‚¤ã‚¯
2. ã€standardã€‘æœ¬æ—¥ã®ã‚´ãƒ¼ãƒ«ãƒ»ã‚¢ã‚¸ã‚§ãƒ³ãƒ€
3. ã€quoteã€‘ã‚­ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
4. ã€sectionã€‘ã‚»ã‚¯ã‚·ãƒ§ãƒ³1: åŸºç¤çŸ¥è­˜
5. ã€pyramidã€‘å…¨ä½“åƒãƒ»ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
6. ã€standardã€‘è©³ç´°èª¬æ˜ï¼ˆ3-5æšï¼‰
7. ã€statsã€‘ãƒ‡ãƒ¼ã‚¿ãƒ»äº‹ä¾‹
8. ã€comparisonã€‘ã‚ˆãã‚ã‚‹é–“é•ã„ vs æ­£ã—ã„ã‚„ã‚Šæ–¹
9. ã€summaryã€‘ã‚»ã‚¯ã‚·ãƒ§ãƒ³1ã¾ã¨ã‚
10. ã€sectionã€‘ã‚»ã‚¯ã‚·ãƒ§ãƒ³2: å®Ÿè·µã‚¹ã‚­ãƒ«
11. ã€flowã€‘æ‰‹é †ãƒ»ãƒ—ãƒ­ã‚»ã‚¹
12. ã€standardã€‘è©³ç´°èª¬æ˜ï¼ˆ3-5æšï¼‰
13. ã€parallelã€‘ã‚±ãƒ¼ã‚¹ã‚¹ã‚¿ãƒ‡ã‚£
14. ã€twoColumnã€‘æ¼”ç¿’å•é¡Œ
15. ã€summaryã€‘ã‚»ã‚¯ã‚·ãƒ§ãƒ³2ã¾ã¨ã‚
16. ã€sectionã€‘ã‚»ã‚¯ã‚·ãƒ§ãƒ³3: å¿œç”¨
17. ã€matrixã€‘çŠ¶æ³åˆ¥å¯¾å¿œ
18. ã€standardã€‘è©³ç´°èª¬æ˜ï¼ˆ3-5æšï¼‰
19. ã€standardã€‘æ¼”ç¿’ãƒ»ãƒ¯ãƒ¼ã‚¯
20. ã€summaryã€‘ã‚»ã‚¯ã‚·ãƒ§ãƒ³3ã¾ã¨ã‚
21. ã€sectionã€‘ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ³ã‚°
22. ã€summaryã€‘å…¨ä½“ã¾ã¨ã‚
23. ã€standardã€‘Q&A
24. ã€standardã€‘å‚è€ƒè³‡æ–™ãƒ»æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

## å†…å®¹ã®ä½œã‚Šè¾¼ã¿ãƒ«ãƒ¼ãƒ«

### å„ã‚¹ãƒ©ã‚¤ãƒ‰ã®å†…å®¹ã‚’å……å®Ÿã•ã›ã‚‹
- bulletsã¯æœ€ä½3-5å€‹ã€ã§ãã‚Œã°5-7å€‹å…¥ã‚Œã‚‹
- å„bulletã¯å…·ä½“çš„ãªå†…å®¹ï¼ˆã€Œã€‡ã€‡ã‚’è¡Œã†ã€ã§ã¯ãªãã€Œâ–³â–³ã®ãŸã‚ã«ã€‡ã€‡ã‚’â–¡â–¡ã™ã‚‹ã€ï¼‰
- messageã¯çµè«–ã‚’æ˜ç¢ºã«è¿°ã¹ã‚‹
- bodyã«ã¯è£œè¶³èª¬æ˜ã‚’å…¥ã‚Œã‚‹

### å…·ä½“ä¾‹ã‚’å¤šãå…¥ã‚Œã‚‹
- æŠ½è±¡çš„ãªèª¬æ˜ã ã‘ã§ãªãã€å…·ä½“çš„ãªä¾‹ã‚’å¿…ãšå«ã‚ã‚‹
- æ•°å€¤ã‚„ãƒ‡ãƒ¼ã‚¿ã‚’ç©æ¥µçš„ã«ä½¿ã†
- ã€Œä¾‹ãˆã°ã€ã€Œå…·ä½“çš„ã«ã¯ã€ã‚’æ„è­˜

### ç ”ä¿®å‘ã‘ç‰¹åˆ¥ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
- ã€Œè€ƒãˆã¦ã¿ã‚ˆã†ã€ã€Œãƒ‡ã‚£ã‚¹ã‚«ãƒƒã‚·ãƒ§ãƒ³ã€ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’å«ã‚ã‚‹
- ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆå½¢å¼ã®ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’æ´»ç”¨
- Before/After ã®äº‹ä¾‹ã‚’å¤šç”¨
- å¤±æ•—ä¾‹ã¨æˆåŠŸä¾‹ã®å¯¾æ¯”

## ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆé¸æŠã®ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³
- ãƒ—ãƒ­ã‚»ã‚¹ã‚„æ‰‹é †ã®èª¬æ˜ï¼ˆæ¨ªã®æµã‚Œï¼‰ â†’ flow
- ãƒ—ãƒ­ã‚»ã‚¹ã‚„æ‰‹é †ã®èª¬æ˜ï¼ˆç¸¦ã®æµã‚Œï¼‰ â†’ verticalFlow
- å¾ªç’°ãƒ—ãƒ­ã‚»ã‚¹ï¼ˆPDCAç­‰ï¼‰ â†’ cycle
- ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒ»ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« â†’ timeline
- éšå±¤æ§‹é€ ã‚„æˆç†Ÿåº¦ â†’ pyramid
- çµ„ç¹”å›³ãƒ»åˆ†é¡æ§‹é€  â†’ tree
- å„ªå…ˆåº¦ã‚„åˆ†é¡ãƒãƒˆãƒªã‚¯ã‚¹ â†’ matrix
- è¤‡æ•°ã®é¸æŠè‚¢ã‚„å½¹å‰²æ¯”è¼ƒ â†’ parallel
- è¤‡æ•°è¦ç´ ã®å‡ç­‰é…ç½® â†’ grid
- 2-3è¦ç´ ã®é‡ãªã‚Šãƒ»å…±é€šç‚¹ â†’ venn
- é¡§å®¢è¡Œå‹•ã‚„çµã‚Šè¾¼ã¿ãƒ—ãƒ­ã‚»ã‚¹ â†’ funnel
- è©³ç´°ãƒ‡ãƒ¼ã‚¿ã®æ¯”è¼ƒ â†’ table
- ã‚ˆãã‚ã‚‹è³ªå• â†’ qa
- å°å…¥äº‹ä¾‹ãƒ»æˆåŠŸäº‹ä¾‹ â†’ caseStudy
- æ•°å€¤ãƒ‡ãƒ¼ã‚¿ã®å¼·èª¿ â†’ stats
- Before/Afteræ¯”è¼ƒ â†’ comparison
- 2ã¤ã®è¦³ç‚¹ã®å¯¾æ¯” â†’ twoColumn
- é€šå¸¸ã®èª¬æ˜ â†’ standard

## ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ›¸ãæ–¹
æ‚ªã„ä¾‹:ã€Œå£²ä¸Šã«ã¤ã„ã¦ã€ã€Œãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°æˆ¦ç•¥ã€
è‰¯ã„ä¾‹:ã€Œå£²ä¸Šã¯å‰å¹´æ¯”150%å¢—åŠ ã—ã€ç›®æ¨™ã‚’é”æˆã—ãŸã€
è‰¯ã„ä¾‹:ã€Œãƒ‡ã‚¸ã‚¿ãƒ«ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ã¸ã®æŠ•è³‡ã‚’å€å¢—ã™ã¹ãã§ã‚ã‚‹ã€

## é‡è¦ãªãƒ«ãƒ¼ãƒ«
- å„ã‚¹ãƒ©ã‚¤ãƒ‰ã«layoutã‚’å¿…ãšæŒ‡å®šã™ã‚‹
- messageãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯å¯èƒ½ãªé™ã‚Šè¨­å®šï¼ˆsection, quoteã¯ä»»æ„ï¼‰
- statsãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§ã¯2-4å€‹ã®statsã‚’å«ã‚ã‚‹
- flowãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§ã¯3-5ã‚¹ãƒ†ãƒƒãƒ—ã‚’å«ã‚ã‚‹
- verticalFlowãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§ã¯3-5ã‚¹ãƒ†ãƒƒãƒ—ã‚’å«ã‚ã‚‹
- cycleãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§ã¯3-5ã‚¹ãƒ†ãƒƒãƒ—ã‚’å«ã‚ã‚‹
- pyramidãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§ã¯3-5éšå±¤ã‚’å«ã‚ã‚‹
- parallelãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§ã¯3-4ã‚«ãƒ©ãƒ ã‚’å«ã‚ã‚‹
- gridãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§ã¯4-9å€‹ã®è¦ç´ ã‚’å«ã‚ã‚‹
- timelineãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§ã¯3-6å€‹ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å«ã‚ã‚‹
- funnelãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§ã¯3-5æ®µéšã‚’å«ã‚ã‚‹
- tableãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§ã¯3-5åˆ—ã€3-6è¡Œã‚’ç›®å®‰ã«ã™ã‚‹
- qaãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§ã¯3-5å€‹ã®Q&Aã‚’å«ã‚ã‚‹
- bulletsã¯3-7å€‹ã‚’ç›®å®‰ã«å……å®Ÿã•ã›ã‚‹
- ä¼šè©±ã‹ã‚‰èª­ã¿å–ã‚Œã‚‹æƒ…å ±ã‚’æœ€å¤§é™æ´»ç”¨ã™ã‚‹
- æƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã‚‹éƒ¨åˆ†ã¯ä¸€èˆ¬çŸ¥è­˜ã§è£œå®Œã—ã¦å…·ä½“çš„ãªå†…å®¹ã‚’å…¥ã‚Œã‚‹
- ç™ºè¡¨æ™‚é–“ã®è¨€åŠãŒã‚ã‚Œã°ã€ä¸Šè¨˜ã®ç›®å®‰ã«å¾“ã£ã¦ååˆ†ãªæšæ•°ã‚’ç”Ÿæˆã™ã‚‹
- ç ”ä¿®ãƒ»æ•™è‚²ã®å ´åˆã¯ç‰¹ã«æšæ•°ã‚’å¤šã‚ã«
- JSONä»¥å¤–ã®ãƒ†ã‚­ã‚¹ãƒˆã¯çµ¶å¯¾ã«å‡ºåŠ›ã—ãªã„

## å‡ºåŠ›å½¢å¼ï¼ˆå³å®ˆï¼‰
ä»¥ä¸‹ã®å½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚ä»–ã®ã‚­ãƒ¼ã§å›²ã¾ãªã„ã“ã¨ï¼š
{
  "title": "ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒˆãƒ«",
  "subtitle": "ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«",
  "slides": [
    { "layout": "section", "title": "...", "message": "..." },
    { "layout": "standard", "title": "...", "message": "...", "bullets": [...] },
    ...
  ]
}`;

export async function POST(request: NextRequest) {
  try {
    const { history } = await request.json();

    if (!OPENROUTER_API_KEY) {
      return NextResponse.json(
        { success: false, error: 'OpenRouter API key not configured' } as GenerateSlideResponse,
        { status: 500 }
      );
    }

    // Step 1: AIã«ã‚¹ãƒ©ã‚¤ãƒ‰æ§‹é€ ã‚’ç”Ÿæˆã•ã›ã‚‹
    const messages = [
      { role: 'system', content: SYSTEM_PROMPT },
      ...history.map((msg: ChatMessage) => ({
        role: msg.role === 'model' ? 'assistant' : 'user',
        content: msg.parts[0].text,
      })),
      { role: 'user', content: 'ä¸Šè¨˜ã®ä¼šè©±å†…å®¹ã‚’ã‚‚ã¨ã«ã€ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ãƒ©ã‚¤ãƒ‰ã®JSONæ§‹é€ ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚ä¼šè©±ã‹ã‚‰èª­ã¿å–ã‚Œã‚‹ç™ºè¡¨æ™‚é–“ã«å¿œã˜ã¦ã€å¿…ãšååˆ†ãªæšæ•°ã®ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚ç ”ä¿®ã‚„æ•™è‚²ç›®çš„ã®å ´åˆã¯ç‰¹ã«æšæ•°ã‚’å¤šãã—ã€å„ã‚¹ãƒ©ã‚¤ãƒ‰ã®å†…å®¹ã‚‚å……å®Ÿã•ã›ã¦ãã ã•ã„ã€‚' },
    ];

    const aiResponse = await fetch('https://openrouter.ai/api/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${OPENROUTER_API_KEY}`,
        'Content-Type': 'application/json',
        'HTTP-Referer': process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000',
        'X-Title': 'Slide AI',
      },
      body: JSON.stringify({
        model: MODEL,
        messages,
        response_format: { type: 'json_object' },
        max_tokens: 16000, // é•·ã„å‡ºåŠ›ã«å¯¾å¿œ
      }),
    });

    if (!aiResponse.ok) {
      const error = await aiResponse.text();
      console.error('OpenRouter API error:', error);
      return NextResponse.json(
        { success: false, error: 'AIã‹ã‚‰ã®å¿œç­”å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' } as GenerateSlideResponse,
        { status: 500 }
      );
    }

    const aiData = await aiResponse.json();
    const slideJsonString = aiData.choices?.[0]?.message?.content;

    if (!slideJsonString) {
      return NextResponse.json(
        { success: false, error: 'ã‚¹ãƒ©ã‚¤ãƒ‰æ§‹é€ ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ' } as GenerateSlideResponse,
        { status: 500 }
      );
    }

    let slideData: SlideData;
    try {
      const parsed = JSON.parse(slideJsonString);
      console.log('AI generated JSON:', JSON.stringify(parsed, null, 2));

      // AIã®å‡ºåŠ›å½¢å¼ã‚’æ­£è¦åŒ–ï¼ˆæ§˜ã€…ãªå½¢å¼ã«å¯¾å¿œï¼‰
      if (parsed.slideData) {
        // { slideData: { title, slides } } å½¢å¼
        slideData = parsed.slideData;
      } else if (parsed.presentation) {
        // { presentation: { title, slides } } å½¢å¼
        slideData = parsed.presentation;
      } else if (parsed.title && parsed.slides) {
        // { title, slides } å½¢å¼ï¼ˆæœŸå¾…å½¢å¼ï¼‰
        slideData = parsed;
      } else {
        // ãã®ä»–ã®å½¢å¼ã®å ´åˆã€æœ€åˆã«è¦‹ã¤ã‹ã£ãŸtitleã¨slidesã‚’æ¢ã™
        console.error('Unexpected JSON structure:', Object.keys(parsed));
        slideData = parsed;
      }

      // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æ¤œè¨¼
      if (!slideData.title || !slideData.slides || !Array.isArray(slideData.slides)) {
        console.error('Invalid slideData structure:', slideData);
        return NextResponse.json(
          { success: false, error: 'ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®æ§‹é€ ãŒä¸æ­£ã§ã™' } as GenerateSlideResponse,
          { status: 500 }
        );
      }
    } catch (e) {
      console.error('Failed to parse slide JSON:', slideJsonString);
      return NextResponse.json(
        { success: false, error: 'ã‚¹ãƒ©ã‚¤ãƒ‰JSONã®ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸ' } as GenerateSlideResponse,
        { status: 500 }
      );
    }

    // Step 2: GASã«ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡
    if (!GAS_WEBAPP_URL) {
      // GASæœªè¨­å®šã®å ´åˆã¯ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®ã¿è¿”ã™
      return NextResponse.json({
        success: true,
        slideData,
        message: 'GAS_WEBAPP_URLãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ãŸã‚ã€ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®ã¿è¿”ã—ã¾ã™',
      });
    }

    const gasResponse = await fetch(GAS_WEBAPP_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'text/plain;charset=utf-8',
      },
      body: JSON.stringify({ slideData }),
      redirect: 'follow',
    });

    const gasText = await gasResponse.text();
    console.log('GAS Response:', gasText);

    let gasData;
    try {
      gasData = JSON.parse(gasText);
    } catch (e) {
      console.error('GAS API error (not JSON):', gasText);
      return NextResponse.json(
        { success: false, error: 'Google Slidesã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ', slideData } as GenerateSlideResponse & { slideData: SlideData },
        { status: 500 }
      );
    }

    if (!gasData.success) {
      console.error('GAS API error:', gasData.error);
      return NextResponse.json(
        { success: false, error: gasData.error || 'Google Slidesã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ', slideData } as GenerateSlideResponse & { slideData: SlideData },
        { status: 500 }
      );
    }

    return NextResponse.json({
      success: true,
      slideUrl: gasData.slideUrl,
      slideId: gasData.slideId,
    } as GenerateSlideResponse);

  } catch (error) {
    console.error('Generate slides API error:', error);
    return NextResponse.json(
      { success: false, error: 'å†…éƒ¨ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' } as GenerateSlideResponse,
      { status: 500 }
    );
  }
}
